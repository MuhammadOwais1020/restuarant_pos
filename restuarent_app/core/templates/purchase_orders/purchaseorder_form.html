{% extends 'base.html' %} {% load custom_filters %}
{% block title %}{% if view.object %}Edit{% else %}New{% endif %} Purchase Order{% endblock %}
{% block extra_head %}
<style>
  .po-wrapper { display: grid; grid-template-columns: 1fr 380px; gap: 1rem; min-height: calc(100vh - 140px); }
  @media (max-width: 992px){ .po-wrapper { grid-template-columns: 1fr; } }
  .po-left { overflow: auto; padding-right: .5rem; }
  .po-right { position: sticky; top: 78px; height: fit-content; }
  .table thead th { position: sticky; top: 0; background: #fff; z-index: 1; }
  .small-muted { font-size:.875rem; color:#666; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">{% if view.object %}<i class="fa fa-edit"></i> Edit{% else %}<i class="fa fa-plus"></i> New{% endif %} Purchase Order</h4>
    <a href="{% url 'purchase_order_list' %}" class="btn btn-outline-secondary"><i class="fa fa-arrow-left"></i> Back</a>
  </div>

  <form id="po-form" method="post" class="po-wrapper">
    {% csrf_token %}

    <!-- LEFT: Supplier + Items -->
    <div class="po-left">
      <div class="row g-3 mb-2">
        <div class="col-12 col-lg-4">
          <label class="form-label">Supplier</label>
          {{ form.supplier|add_class:"form-select" }}
          <div id="supplierDue" class="small-muted mt-1">Previous Due: —</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong>Items</strong>
          <button type="button" id="add-item-btn" class="btn btn-sm btn-primary"><i class="fa fa-plus"></i> Add Material</button>
        </div>
        <div class="table-responsive" style="max-height:60vh;">
          <table class="table table-bordered table-hover mb-0 align-middle">
            <thead class="table-light">
              <tr>
                <th style="width:50px">#</th>
                <th>Material</th>
                <th style="width:140px">Qty</th>
                <th style="width:170px">Unit Price</th>
                <th style="width:160px" class="text-end">Line Total</th>
                <th style="width:80px">Action</th>
              </tr>
            </thead>
            <tbody id="po-items-container"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- RIGHT: Summary + Payment -->
    <div class="po-right">
      <div class="card">
        <div class="card-header"><strong>Summary & Payment</strong></div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label">Subtotal (₨)</label>
            <input type="text" class="form-control" id="subtotal" readonly>
          </div>

          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">Tax %</label>
              <input type="number" step="0.01" min="0" id="tax_percent" name="tax_percent" class="form-control" value="{{ view.object.tax_percent|default_if_none:'0' }}">
            </div>
            <div class="col-6">
              <label class="form-label">Discount %</label>
              <input type="number" step="0.01" min="0" id="discount_percent" name="discount_percent" class="form-control" value="{{ view.object.discount_percent|default_if_none:'0' }}">
            </div>
          </div>

          <div class="mt-3">
            <label class="form-label">Net Total (₨)</label>
            <input type="text" class="form-control" id="net_total" readonly>
          </div>

          <hr>
          <div class="mb-2">
            <div class="small-muted">Previous Due (Supplier)</div>
            <div class="fs-6" id="previous_due">—</div>
          </div>

          <div class="mb-3">
            <label class="form-label">Amount Paying Now (₨)</label>
            <input type="number" step="0.01" min="0" class="form-control" id="paid_amount" name="paid_amount"
                   value="{% if linked_payment %}{{ linked_payment.amount }}{% else %}0{% endif %}">
          </div>

          <div class="mb-3">
            <label class="form-label">Payment Source</label>
            <select name="payment_source" id="payment_source" class="form-select">
              <option value="cash" {% if not linked_payment or linked_payment.payment_source == 'cash' %}selected{% endif %}>Cash</option>
              <option value="bank" {% if linked_payment and linked_payment.payment_source == 'bank' %}selected{% endif %}>Bank</option>
            </select>
          </div>

          <div class="mb-3" id="bankRow" style="display:none;">
            <label class="form-label">Bank Account</label>
            <select name="bank_account" id="bank_account" class="form-select">
              <option value="">— Select bank —</option>
              {% for b in bank_accounts %}
                <option value="{{ b.id }}" {% if linked_payment and linked_payment.bank_account_id == b.id %}selected{% endif %}>{{ b.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-2">
            <div class="small-muted">Remaining After Payment</div>
            <div class="fs-6" id="remaining_after">—</div>
          </div>

          <input type="hidden" name="po_items_json" id="id_po_items_json">
          <button type="submit" class="btn btn-primary w-100 mt-2"><i class="fa fa-save"></i> Save</button>
        </div>
      </div>
    </div>
  </form>
</div>

<script>
  // ---------- DATA ----------
  const materials = JSON.parse('{{ raw_materials_json|safe }}');
  let lines = {{ initial_po_items_json|safe }};
  
  // ---------- Helpers ----------
  function fmt2(x){ const n = Number(x||0); return isFinite(n) ? n.toFixed(2) : '0.00'; }

  function calcSubtotal(){
    return lines.reduce((s,it)=> s + (Number(it.quantity||0) * Number(it.unit_price||0)), 0);
  }

  function render(){
    const tbody = document.getElementById('po-items-container');
    tbody.innerHTML = '';
    lines.forEach((it,i)=>{
      const opts = materials.map(m=> `<option value="${m.pk}" ${m.pk===it.raw_material_id?'selected':''}>
         ${m.name} (${m.unit})
      </option>`).join('');
      const row = document.createElement('tr');
      row.dataset.i = i;
      row.innerHTML = `
        <td>${i+1}</td>
        <td><select class="form-select sel-mat">${opts}</select></td>
        <td><input type="number" class="form-control inp-qty" min="0.01" step="0.01" value="${it.quantity||1}"></td>
        <td><input type="number" class="form-control inp-up" min="0" step="0.01" value="${it.unit_price||0}"></td>
        <td class="text-end td-total">${fmt2((it.quantity||0)*(it.unit_price||0))}</td>
        <td><button type="button" class="btn btn-sm btn-outline-danger btn-remove"><i class="fa fa-trash"></i></button></td>
      `;
      tbody.appendChild(row);
    });
    recalcSummary();
  }

  function recalcSummary(){
    const subtotal = calcSubtotal();
    document.getElementById('subtotal').value = fmt2(subtotal);

    const tax = Number(document.getElementById('tax_percent').value||0);
    const disc = Number(document.getElementById('discount_percent').value||0);
    const taxAmt  = subtotal * tax / 100.0;
    const discAmt = subtotal * disc / 100.0;
    const net = subtotal + taxAmt - discAmt;
    document.getElementById('net_total').value = fmt2(net);

    const prevDue = Number((document.getElementById('previous_due').dataset.val)||0);
    const paidNow = Number(document.getElementById('paid_amount').value||0);
    const remaining = prevDue + net - paidNow;
    document.getElementById('remaining_after').innerText = '₨ ' + fmt2(remaining);
  }

  // ---------- Events ----------
  document.getElementById('add-item-btn').addEventListener('click', ()=>{
    const first = materials[0]; if(!first) return;
    lines.push({ raw_material_id: first.pk, quantity: 1, unit_price: 0 });
    render();
  });

  document.getElementById('po-items-container').addEventListener('input', (e)=>{
    const row = e.target.closest('tr'); if(!row) return;
    const i = +row.dataset.i;
    if(e.target.classList.contains('sel-mat')) { lines[i].raw_material_id = +e.target.value; }
    if(e.target.classList.contains('inp-qty')) { lines[i].quantity = +e.target.value; }
    if(e.target.classList.contains('inp-up'))  { lines[i].unit_price = +e.target.value; }
    row.querySelector('.td-total').innerText = fmt2(lines[i].quantity*lines[i].unit_price);
    recalcSummary();
  });

  document.getElementById('po-items-container').addEventListener('click', (e)=>{
    if(e.target.closest('.btn-remove')){
      const i = +e.target.closest('tr').dataset.i;
      lines.splice(i,1); render();
    }
  });

  ['tax_percent','discount_percent','paid_amount'].forEach(id=>{
    const el = document.getElementById(id);
    el.addEventListener('input', recalcSummary);
  });

  const paySrc = document.getElementById('payment_source');
  const bankRow = document.getElementById('bankRow');
  paySrc.addEventListener('change', ()=>{
    bankRow.style.display = (paySrc.value==='bank') ? '' : 'none';
    recalcSummary();
  });
  bankRow.style.display = (paySrc.value==='bank') ? '' : 'none';

  const supplierSelect = document.getElementById('id_supplier');
  function fetchSupplierDue(){
    const sid = supplierSelect.value;
    if(!sid){ document.getElementById('supplierDue').innerText='Previous Due: —'; return; }
    fetch(`{% url 'supplier_balance_json' %}?supplier_id=${sid}`)
      .then(r=>r.json())
      .then(d=>{
        const el = document.getElementById('previous_due');
        el.innerText = '₨ ' + fmt2(d.previous_due);
        el.dataset.val = d.previous_due;
        document.getElementById('supplierDue').innerText = 'Previous Due: ₨ ' + fmt2(d.previous_due);
        recalcSummary();
      });
  }
  supplierSelect.addEventListener('change', fetchSupplierDue);
  fetchSupplierDue();

  // Submit (AJAX via your AjaxableResponseMixin style)
  document.getElementById('po-form').addEventListener('submit', function(e){
    e.preventDefault();
    document.getElementById('id_po_items_json').value = JSON.stringify(lines);
    const fd = new FormData(this);
    fetch(window.location.href, { method: 'POST', body: fd, headers: { 'X-Requested-With':'XMLHttpRequest' } })
      .then(r=> r.ok ? r : r.json().then(j=>Promise.reject(j)))
      .then(()=> { if(window.showAlert) showAlert('success','Saved'); window.location.href = "{% url 'purchase_order_list' %}"; })
      .catch(err=> { if(window.showAlert) showAlert('error', (err && err.errors) ? JSON.stringify(err.errors) : 'Error'); });
  });

  // initial render
  render();
</script>
{% endblock %}
