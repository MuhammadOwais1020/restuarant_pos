{% extends 'base.html' %}
{% load static %}
{% block title %}Reports & Analytics{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  .kpi-card{background:#fff;border-radius:.5rem;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:1rem}
  .kpi-val{font-size:1.35rem;font-weight:700}
  .kpi-label{color:#6c757d;font-size:.85rem}
  .filters .form-label{margin-bottom:.25rem}
  .chart-card{background:#fff;border-radius:.5rem;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:1rem;height:100%}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0"><i class="fa fa-chart-line"></i> Reports & Analytics</h4>
  </div>

  <!-- Filters -->
  <form method="get" class="filters row g-2 align-items-end mb-3">
    <div class="col-12 col-lg-3">
      <label class="form-label">From (date & time)</label>
      <input type="datetime-local" name="from" class="form-control" value="{{ from }}">
    </div>
    <div class="col-12 col-lg-3">
      <label class="form-label">To (date & time)</label>
      <input type="datetime-local" name="to" class="form-control" value="{{ to }}">
    </div>
    <div class="col-12 col-lg-3">
      <label class="form-label">Business Mode</label>
      <select name="mode" class="form-select">
        <option value="recipe" {% if mode == 'recipe' %}selected{% endif %}>Recipe (COGS from recipes)</option>
        <option value="simple" {% if mode == 'simple' %}selected{% endif %}>Simple (Purchases as cost)</option>
      </select>
    </div>
    <div class="col-12 col-lg-3 d-flex gap-2">
      <button class="btn btn-primary w-100"><i class="fa fa-filter"></i> Apply</button>
      <button type="button" class="btn btn-outline-secondary w-100" onclick="window.print()"><i class="fa fa-print"></i> Print</button>
    </div>
  </form>

  <!-- KPIs -->
  <div class="row g-3 mb-2">
    <div class="col-6 col-lg-3"><div class="kpi-card"><div class="kpi-label">Revenue</div><div class="kpi-val">₨ {{ kpi_revenue }}</div></div></div>
    <div class="col-6 col-lg-3"><div class="kpi-card"><div class="kpi-label">{{ cost_label }}</div><div class="kpi-val">₨ {{ kpi_cost }}</div></div></div>
    <div class="col-6 col-lg-3"><div class="kpi-card"><div class="kpi-label">Other Expenses</div><div class="kpi-val">₨ {{ kpi_other }}</div></div></div>
    <div class="col-6 col-lg-3"><div class="kpi-card"><div class="kpi-label">Net Profit</div><div class="kpi-val">₨ {{ kpi_profit }}</div></div></div>
  </div>

  <!-- Charts -->
  <div class="row g-3">
    <div class="col-12 col-xl-7">
      <div class="chart-card">
        <h6 class="mb-2">Daily Revenue vs Cost vs Profit</h6>
        <canvas id="dailyChart"></canvas>
      </div>
    </div>
    <div class="col-12 col-xl-5">
      <div class="chart-card">
        <h6 class="mb-2">Monthly Trend (Last 12 Months)</h6>
        <canvas id="trendChart"></canvas>
      </div>
    </div>
    <div class="col-12">
      <div class="chart-card">
        <h6 class="mb-2">Expenses by Category (in selected range)</h6>
        <canvas id="expenseChart"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
  // Data from view
  const days    = {{ days|safe }};
  const rev     = {{ series_revenue|safe }};
  const cost    = {{ series_cost|safe }};
  const expense = {{ series_expense|safe }};
  const profit  = {{ series_profit|safe }};

  const months  = {{ months|safe }};
  const trendR  = {{ trend_revenue|safe }};
  const trendP  = {{ trend_profit|safe }};

  // Bootstrap-like palette
  const COLORS = {
    revenue:  { line: '#3c8affff', fill: 'rgba(13,110,253,.12)' },   // primary
    cost:     { line: '#fb933eff', fill: 'rgba(253,126,20,.12)' },    // orange
    expense:  { line: '#f55061ff', fill: 'rgba(220,53,69,.12)' },     // danger
    profit:   { line: '#38cc87ff', fill: 'rgba(25,135,84,.15)' },     // success
  };

  // Daily combined line
  new Chart(document.getElementById('dailyChart'), {
    type: 'line',
    data: {
      labels: days,
      datasets: [
        {
          label: 'Revenue',
          data: rev,
          borderWidth: 2,
          fill: true,
          borderColor: COLORS.revenue.line,
          backgroundColor: COLORS.revenue.fill,
          pointRadius: 2,
          pointBackgroundColor: COLORS.revenue.line,
          tension: 0.25
        },
        {
          label: '{{ cost_label }}',
          data: cost,
          borderWidth: 2,
          fill: true,
          borderColor: COLORS.cost.line,
          backgroundColor: COLORS.cost.fill,
          pointRadius: 2,
          pointBackgroundColor: COLORS.cost.line,
          tension: 0.25
        },
        {
          label: 'Other Expenses',
          data: expense,
          borderWidth: 2,
          fill: true,
          borderColor: COLORS.expense.line,
          backgroundColor: COLORS.expense.fill,
          pointRadius: 2,
          pointBackgroundColor: COLORS.expense.line,
          tension: 0.25
        },
        {
          label: 'Profit',
          data: profit,
          borderWidth: 2,
          fill: true,
          borderColor: COLORS.profit.line,
          backgroundColor: COLORS.profit.fill,
          pointRadius: 2,
          pointBackgroundColor: COLORS.profit.line,
          tension: 0.25
        },
      ],
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top' }
      },
      scales: {
        x: { grid: { display: false } },
        y: { beginAtZero: true }
      }
    }
  });

  // Monthly trend bars
  new Chart(document.getElementById('trendChart'), {
    type: 'bar',
    data: {
      labels: months,
      datasets: [
        {
          label: 'Revenue',
          data: trendR,
          backgroundColor: COLORS.revenue.line,
          borderColor: COLORS.revenue.line,
          borderWidth: 1
        },
        {
          label: 'Profit',
          data: trendP,
          backgroundColor: COLORS.profit.line,
          borderColor: COLORS.profit.line,
          borderWidth: 1
        },
      ],
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top' }
      },
      scales: {
        x: { stacked: false },
        y: { beginAtZero: true }
      }
    }
  });
</script>


{# ================= Extra Analytics (appended) ================= #}
<div class="row g-3 mt-3">
  <!-- Just Sales (Revenue) -->
  <div class="col-12 col-xl-6">
    <div class="chart-card">
      <h6 class="mb-2">Sales (Revenue Only)</h6>
      <canvas id="revenueOnlyChart"></canvas>
    </div>
  </div>

  <!-- Sales by Category -->
  <div class="col-12 col-xl-6">
    <div class="chart-card">
      <h6 class="mb-2">Sales by Category (Qty)</h6>
      <canvas id="salesByCategoryChart"></canvas>
    </div>
  </div>
</div>

<div class="row g-3 mt-3">
  <!-- Expenses by Category -->
  <div class="col-12 col-xl-6">
    <div class="chart-card">
      <h6 class="mb-2">Expenses by Category (Selected Range)</h6>
      <canvas id="expenseByCategoryChart"></canvas>
    </div>
  </div>

  <!-- Items Sold (full list) -->
  <div class="col-12 col-xl-6">
    <div class="chart-card">
      <h6 class="mb-2">All Items Sold (Qty) — Includes items inside deals</h6>
      <div class="table-responsive">
        <table class="table table-sm table-striped align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th style="width:60%">Item</th>
              <th class="text-end">Quantity Sold</th>
            </tr>
          </thead>
          <tbody>
            {% for row in items_sold %}
              <tr>
                <td>{{ row.name }}</td>
                <td class="text-end">{{ row.qty }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="2" class="text-muted text-center">No sales in this period.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>


<script>
  // Extra datasets from view
  const catLabels   = {{ sales_cat_labels|safe }};
  const catValues   = {{ sales_cat_values|safe }};
  const expCatLbls  = {{ exp_cat_labels|safe }};
  const expCatVals  = {{ exp_cat_values|safe }};

  // Sales (Revenue Only) — simple line using the same days/revenue series
  new Chart(document.getElementById('revenueOnlyChart'), {
    type: 'line',
    data: {
      labels: {{ days|safe }},
      datasets: [{ label: 'Revenue', data: {{ series_revenue|safe }}, borderWidth: 2, fill: true }]
    }
  });

  // Sales by Category (Qty)
  new Chart(document.getElementById('salesByCategoryChart'), {
    type: 'bar',
    data: {
      labels: catLabels,
      datasets: [{ label: 'Qty', data: catValues }]
    },
    options: { indexAxis: 'y' }
  });

  // Expenses by Category (mode aware)
  new Chart(document.getElementById('expenseByCategoryChart'), {
    type: 'doughnut',
    data: {
      labels: expCatLbls,
      datasets: [{ label: 'Amount', data: expCatVals }]
    }
  });
</script>

{% endblock %}
